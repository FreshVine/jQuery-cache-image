(function(e){e.fn.cacheImages=function(t){this.cacheImagesConfig=e.extend({},{debug:false,defaultImage:"data:image/png;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAHgAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAEAsLCwwLEAwMEBcPDQ8XGxQQEBQbHxcXFxcXHx4XGhoaGhceHiMlJyUjHi8vMzMvL0BAQEBAQEBAQEBAQEBAQAERDw8RExEVEhIVFBEUERQaFBYWFBomGhocGhomMCMeHh4eIzArLicnJy4rNTUwMDU1QEA/QEBAQEBAQEBAQEBA/8AAEQgAZABkAwEiAAIRAQMRAf/EAEsAAQEAAAAAAAAAAAAAAAAAAAAFAQEAAAAAAAAAAAAAAAAAAAAAEAEAAAAAAAAAAAAAAAAAAAAAEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//2Q==",encodeOnCanvas:false,storagePrefix:"cached",url:null},t);this.cacheImagesConfig.encodeOnCanvas=typeof HTMLCanvasElement!=undefined?this.cacheImagesConfig.encodeOnCanvas:false;var n=this;if(/^data:image/.test(this.cacheImagesConfig.defaultImage)===false){this.cacheImagesConfig.defaultSrc=this.cacheImagesConfig.defaultImage}var r=function(e){try{var t=document.createElement("canvas");t.width=e.width;t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=e.src.match(/\.(jpg|jpeg|png)$/i);if(r&&r.length){r=r[1].toLowerCase()=="jpg"?"jpeg":r[1].toLowerCase()}else{throw"Invalid image type for canvas encoder: "+e.src}return t.toDataURL("image/"+r)}catch(i){console&&console.log(i);return"error"}};var i=function(e){var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=new Uint8Array(e),i=r.byteLength,s=i%3,o=i-s,u,a,f,l,c;for(var h=0;h<o;h=h+3){c=r[h]<<16|r[h+1]<<8|r[h+2];u=(c&16515072)>>18;a=(c&258048)>>12;f=(c&4032)>>6;l=c&63;t+=n[u]+n[a]+n[f]+n[l]}if(s===1){c=r[o];u=(c&252)>>2;a=(c&3)<<4;t+=n[u]+n[a]+"=="}else if(s===2){c=r[o]<<8|r[o+1];u=(c&16128)>>8;a=(c&1008)>>4;f=(c&15)<<2;t+=n[u]+n[a]+n[f]+"="}return t};e(function(){e(n).each(function(t,s){var o=e(s),u=o.prop("src")||o.data("cachedImageSrc");if(n.cacheImagesConfig.url!==null){u=n.cacheImagesConfig.url;o.prop("src","")}var a=n.cacheImagesConfig.storagePrefix+":"+u,f=localStorage[a];if(typeof localStorage!=="object"){if(n.cacheImagesConfig.debug){console.log("localStorage is not available")}return false}if(typeof u==="undefined"){return true}if(typeof o.prop("src")!=="undefined"&&o.prop("src").substring(0,5)==="data:"){return true}if(f&&/^data:image/.test(f)){o.data("cachedImageSrc",u);o.prop("src",f)}else{o.prop("src","");var l=u.match(/\.(jpg|jpeg|png|gif)$/i);if(l&&l.length){l=l[1].toLowerCase()=="jpg"?"jpeg":l[1].toLowerCase()}if(typeof l==="undefined"){return true}if(localStorage[a]!=="pending"){localStorage[a]="pending";o.data("cachedImageSrc",u);if(n.cacheImagesConfig.encodeOnCanvas&&l!=="gif"){o.load(function(){localStorage[a]=u=r(s);if(u.substring(0,5)==="data:"){o.prop("src",localStorage[a]);if(o.is(".cacheImagesRemove")){o.remove()}}})}else{var c=new XMLHttpRequest;c.open("GET",u,true);c.responseType="arraybuffer";c.onload=function(e){if(this.status==200&&e.totalSize>0){localStorage[a]="data:image/"+l+";base64,"+i(this.response);o.prop("src",localStorage[a]);if(o.is(".cacheImagesRemove")){o.remove()}}else{localStorage[a]="error";if(typeof n.cacheImagesConfig.defaultSrc!=="undefined"){var t=n.cacheImagesConfig.storagePrefix+":"+n.cacheImagesConfig.defaultSrc;if(typeof localStorage[t]!=="undefined"){o.prop("src",localStorage[t])}else{o.cacheImages({url:n.cacheImagesConfig.defaultSrc})}}else{o.prop("src",n.cacheImagesConfig.defaultImage)}}};c.send()}}}})});return this};window.cacheImagesFetchURL=function(t){e("body").append(e('<img style="display: none;" />').addClass("cacheImagesRemove").cacheImages({url:t}))};window.cacheImagesOutput=function(e,t){if(typeof t==="undefined"){t="cached"}var n=t+":"+e;if(window.localStorage.getItem(n)!=null){return window.localStorage.getItem(n)}else{if(/^data:image/.test(this.cacheImagesConfig.defaultImage)===true){return this.cacheImagesConfig.defaultImage}n=t+":"+this.cacheImagesConfig.defaultImage;if(window.localStorage.getItem(n)!=null){return window.localStorage.getItem(n)}}return null};window.cacheImagesDrop=function(e){var t=[],n=false;if(typeof e==="undefined"){e="cached"}for(i=0;i<window.localStorage.length;i++){if(window.localStorage.key(i).substr(0,e.length+1)!==e+":"){continue}t.push(window.localStorage.key(i))}if(t.length===0){if(n){console.log("No Images to Drop")}return true}for(i=0;i<t.length;i++){if(n){console.log("Dropping localStorage Key:",t[i])}window.localStorage.removeItem(t[i])}if(n){console.log("Dropped "+t.length+" images from localStorage")}return true}})(jQuery)