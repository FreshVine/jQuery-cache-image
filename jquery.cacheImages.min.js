(function(e){e.fn.cacheImages=function(t){this.cacheImagesConfig=e.extend({},e.fn.cacheImages.defaults,t);this.cacheImagesConfig.encodeOnCanvas=typeof HTMLCanvasElement!=undefined?this.cacheImagesConfig.encodeOnCanvas:false;var n=this;if(/^data:image/.test(this.cacheImagesConfig.defaultImage)===false){this.cacheImagesConfig.defaultSrc=this.cacheImagesConfig.defaultImage}return this.each(function(t,r){var i=e(r),s=i.prop("src")||i.data("cachedImageSrc");if(n.cacheImagesConfig.url!==null){s=n.cacheImagesConfig.url;i.prop("src","")}var o=n.cacheImagesConfig.storagePrefix+":"+s,u=localStorage[o];if(typeof localStorage!=="object"){if(n.cacheImagesConfig.debug){console.log("localStorage is not available")}return false}if(typeof s==="undefined"){return true}if(typeof i.prop("src")!=="undefined"&&i.prop("src").substring(0,5)==="data:"){return true}if(u&&/^data:image/.test(u)){i.data("cachedImageSrc",s);i.prop("src",u)}else{i.prop("src","");var a=s.match(/\.(jpg|jpeg|png|gif)$/i);if(a&&a.length){a=a[1].toLowerCase()=="jpg"?"jpeg":a[1].toLowerCase()}if(typeof a==="undefined"){return true}if(localStorage[o]!=="pending"){localStorage[o]="pending";i.data("cachedImageSrc",s);if(n.cacheImagesConfig.encodeOnCanvas&&a!=="gif"){i.load(function(){localStorage[o]=s=e.fn.cacheImages.base64EncodeCanvas(r);if(s.substring(0,5)==="data:"){i.prop("src",localStorage[o]);if(i.is(".cacheImagesRemove")){i.remove()}}})}else{var f=new XMLHttpRequest;f.open("GET",s,true);f.responseType="arraybuffer";f.onload=function(t){if(this.status==200&&t.totalSize>0){localStorage[o]="data:image/"+a+";base64,"+e.fn.cacheImages.base64EncodeResponse(this.response);i.prop("src",localStorage[o]);if(i.is(".cacheImagesRemove")){i.remove()}n.cacheImagesConfig.done.call(i,false);n.cacheImagesConfig.always.call(i)}else{localStorage[o]="error";if(typeof n.cacheImagesConfig.defaultSrc!=="undefined"){var r=n.cacheImagesConfig.storagePrefix+":"+n.cacheImagesConfig.defaultSrc;if(typeof localStorage[r]!=="undefined"){i.prop("src",localStorage[r]);n.cacheImagesConfig.done.call(i);n.cacheImagesConfig.always.call(i)}else{i.cacheImages({url:n.cacheImagesConfig.defaultSrc});n.cacheImagesConfig.done.call(i);n.cacheImagesConfig.always.call(i)}}else{i.prop("src",n.cacheImagesConfig.defaultImage);n.cacheImagesConfig.fail.call(i);n.cacheImagesConfig.always.call(i)}}};f.send()}}}});return this};e.fn.cacheImages.defaults={always:function(){},debug:false,defaultImage:"data:image/png;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAHgAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAEAsLCwwLEAwMEBcPDQ8XGxQQEBQbHxcXFxcXHx4XGhoaGhceHiMlJyUjHi8vMzMvL0BAQEBAQEBAQEBAQEBAQAERDw8RExEVEhIVFBEUERQaFBYWFBomGhocGhomMCMeHh4eIzArLicnJy4rNTUwMDU1QEA/QEBAQEBAQEBAQEBA/8AAEQgAZABkAwEiAAIRAQMRAf/EAEsAAQEAAAAAAAAAAAAAAAAAAAAFAQEAAAAAAAAAAAAAAAAAAAAAEAEAAAAAAAAAAAAAAAAAAAAAEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//2Q==",done:function(){},encodeOnCanvas:false,fail:function(){},storagePrefix:"cached",url:null};e.fn.cacheImages.base64EncodeCanvas=function(e){try{var t=document.createElement("canvas");t.width=e.width;t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=e.src.match(/\.(jpg|jpeg|png)$/i);if(r&&r.length){r=r[1].toLowerCase()=="jpg"?"jpeg":r[1].toLowerCase()}else{throw"Invalid image type for canvas encoder: "+e.src}return t.toDataURL("image/"+r)}catch(i){console&&console.log(i);return"error"}};e.fn.cacheImages.base64EncodeResponse=function(e){var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=new Uint8Array(e),i=r.byteLength,s=i%3,o=i-s,u,a,f,l,c;for(var h=0;h<o;h=h+3){c=r[h]<<16|r[h+1]<<8|r[h+2];u=(c&16515072)>>18;a=(c&258048)>>12;f=(c&4032)>>6;l=c&63;t+=n[u]+n[a]+n[f]+n[l]}if(s===1){c=r[o];u=(c&252)>>2;a=(c&3)<<4;t+=n[u]+n[a]+"=="}else if(s===2){c=r[o]<<8|r[o+1];u=(c&16128)>>8;a=(c&1008)>>4;f=(c&15)<<2;t+=n[u]+n[a]+n[f]+"="}return t};e.fn.cacheImages.fetchURL=function(t){e("body").append(e('<img style="display: none;" />').addClass("cacheImagesRemove").cacheImages({url:t}))};e.fn.cacheImages.Output=function(t,n){if(typeof n==="undefined"){n=e.fn.cacheImages.defaults.storagePrefix}var r=n+":"+t;if(window.localStorage.getItem(r)!=null){return window.localStorage.getItem(r)}else{if(/^data:image/.test(this.cacheImagesConfig.defaultImage)===true){return this.cacheImagesConfig.defaultImage}r=n+":"+this.cacheImagesConfig.defaultImage;if(window.localStorage.getItem(r)!=null){return window.localStorage.getItem(r)}}return null};e.fn.cacheImages.drop=function(t){var n=[],r=false;if(typeof t==="undefined"){t=e.fn.cacheImages.defaults.storagePrefix}for(i=0;i<window.localStorage.length;i++){if(window.localStorage.key(i).substr(0,t.length+1)!==t+":"){continue}n.push(window.localStorage.key(i))}if(n.length===0){if(r){console.log("No Images to Drop")}return true}for(i=0;i<n.length;i++){if(r){console.log("Dropping localStorage Key:",n[i])}window.localStorage.removeItem(n[i])}if(r){console.log("Dropped "+n.length+" images from localStorage")}return true}})(jQuery)