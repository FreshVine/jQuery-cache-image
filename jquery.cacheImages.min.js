(function(e){e.fn.cacheImages=function(t){window.cacheImagesConfig=e.extend({},{debug:false,defaultImage:"data:image/png;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAHgAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAEAsLCwwLEAwMEBcPDQ8XGxQQEBQbHxcXFxcXHx4XGhoaGhceHiMlJyUjHi8vMzMvL0BAQEBAQEBAQEBAQEBAQAERDw8RExEVEhIVFBEUERQaFBYWFBomGhocGhomMCMeHh4eIzArLicnJy4rNTUwMDU1QEA/QEBAQEBAQEBAQEBA/8AAEQgAZABkAwEiAAIRAQMRAf/EAEsAAQEAAAAAAAAAAAAAAAAAAAAFAQEAAAAAAAAAAAAAAAAAAAAAEAEAAAAAAAAAAAAAAAAAAAAAEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//2Q==",encodeOnCanvas:false,storagePrefix:"cached",url:null},t);window.cacheImagesConfig.encodeOnCanvas=typeof HTMLCanvasElement!=undefined?window.cacheImagesConfig.encodeOnCanvas:false;var n=this;if(/^data:image/.test(window.cacheImagesConfig.defaultImage)===false){window.cacheImagesConfig.defaultSrc=window.cacheImagesConfig.defaultImage}var r=function(e){try{var t=document.createElement("canvas");t.width=e.width;t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=e.src.match(/\.(jpg|jpeg|png)$/i);if(r&&r.length){r=r[1].toLowerCase()=="jpg"?"jpeg":r[1].toLowerCase()}else{throw"Invalid image type for canvas encoder: "+e.src}return t.toDataURL("image/"+r)}catch(i){console&&console.log(i);return"error"}};var i=function(e){var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=new Uint8Array(e),i=r.byteLength,s=i%3,o=i-s,u,a,f,l,c;for(var h=0;h<o;h=h+3){c=r[h]<<16|r[h+1]<<8|r[h+2];u=(c&16515072)>>18;a=(c&258048)>>12;f=(c&4032)>>6;l=c&63;t+=n[u]+n[a]+n[f]+n[l]}if(s===1){c=r[o];u=(c&252)>>2;a=(c&3)<<4;t+=n[u]+n[a]+"=="}else if(s===2){c=r[o]<<8|r[o+1];u=(c&16128)>>8;a=(c&1008)>>4;f=(c&15)<<2;t+=n[u]+n[a]+n[f]+"="}return t};e(function(){e(n).each(function(t,n){var s=e(n),o=s.prop("src")||s.data("cachedImageSrc");if(window.cacheImagesConfig.url!==null){o=window.cacheImagesConfig.url;s.prop("src","")}var u=window.cacheImagesConfig.storagePrefix+":"+o,a=localStorage[u];if(typeof localStorage!=="object"){if(window.cacheImagesConfig.debug){console.log("localStorage is not available")}return false}if(typeof o==="undefined"){return true}if(typeof s.prop("src")!=="undefined"&&s.prop("src").substring(0,5)==="data:"){return true}if(a&&/^data:image/.test(a)){s.data("cachedImageSrc",o);s.prop("src",a)}else{s.prop("src","");var f=o.match(/\.(jpg|jpeg|png|gif)$/i);if(f&&f.length){f=f[1].toLowerCase()=="jpg"?"jpeg":f[1].toLowerCase()}if(typeof f==="undefined"){return true}if(localStorage[u]!=="pending"){localStorage[u]="pending";s.data("cachedImageSrc",o);if(window.cacheImagesConfig.encodeOnCanvas&&f!=="gif"){s.load(function(){localStorage[u]=o=r(n);if(o.substring(0,5)==="data:"){s.prop("src",localStorage[u]);if(s.is(".cacheImagesRemove")){s.remove()}}})}else{var l=new XMLHttpRequest;l.open("GET",o,true);l.responseType="arraybuffer";l.onload=function(e){if(this.status==200&&e.totalSize>0){localStorage[u]="data:image/"+f+";base64,"+i(this.response);s.prop("src",localStorage[u]);if(s.is(".cacheImagesRemove")){s.remove()}}else{localStorage[u]="error";if(typeof window.cacheImagesConfig.defaultSrc!=="undefined"){var t=window.cacheImagesConfig.storagePrefix+":"+window.cacheImagesConfig.defaultSrc;if(typeof localStorage[t]!=="undefined"){s.prop("src",localStorage[t])}else{s.cacheImages({url:window.cacheImagesConfig.defaultSrc})}}else{s.prop("src",window.cacheImagesConfig.defaultImage)}}};l.send()}}}})});return this};window.cacheImagesFetchURL=function(t){e("body").append(e('<img style="display: none;" />').addClass("cacheImagesRemove").cacheImages({url:t}))};window.cacheImagesDrop=function(){var e=[];for(i=0;i<window.localStorage.length;i++){if(window.localStorage.key(i).substr(0,window.cacheImagesConfig.storagePrefix.length+1)!==window.cacheImagesConfig.storagePrefix+":"){continue}e.push(window.localStorage.key(i))}if(e.length===0){if(window.cacheImagesConfig.debug){console.log("No Images to Drop")}return true}for(i=0;i<e.length;i++){if(window.cacheImagesConfig.debug){console.log("Dropping localStorage Key:",e[i])}window.localStorage.removeItem(e[i])}if(window.cacheImagesConfig.debug){console.log("Dropped "+e.length+" images from localStorage")}return true}})(jQuery)