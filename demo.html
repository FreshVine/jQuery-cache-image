<!DOCTYPE html>
<html lang="en">
  <head>
    <title>jQuery Cache Images v1.0 Plug-in Demo</title>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><!-- please don't add "maximum-scale=1" here. It's bad for accessibility. -->
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<script type="text/javascript" src="assets/jquery-1.9.1.js"></script>
	<script type="text/javascript" src="jquery.cacheImages.js"></script>
	
  </head>
  <body>
    
	<h1>jQuery Cache Images v1.0 Plug-in</h1>

	<p>Use the following buttons to perform some basic checks on the cache</p>
	<p>
		<button id="cacheLoadAll">Display all cached images</button>
		<button onclick="$('#statWindow').html('');">Empty Display</button>
		<button id="dropCache">Empty the Cache</button>
	</p>
	<div id="statWindow" style="text-align: center; border: 5px solid; min-height: 40px;"></div>

	<p>Images are kept in browser's Local Storage as a base64 encoded string. </p>

	<div id="DemoImages">
		<img src="assets/x-all-the-things.png" />
		<img src="assets/cat.gif" />
		<img src="assets/warhol.jpg" />
	</div>


	<h2>Flickr Test</h2>
	<div>
		Here is a dynamic example where we will fetch a bunch of images from Flickr, dynamically insert them into the page, and they all get cached.
		<br />
		<button id="FlickrTest">Load Some Flickr Images</button>
	</div>


	<div id="flickrTest">
		
	</div>

	<script type="text/javascript">
		$('#DemoImages img').cacheImages();
		$(function(){
			// $('#flickrTest').cacheImages({debug: true});
			$(document).on('click','#dropCache', function(){ cacheImagesDrop();	});
			$(document).on('click','#cacheLoadAll', function(){	cacheImagesShowAll( $('#statWindow') ); });
			$(document).on('click','#FlickrTest', function(){
				var jxhr = $.ajax( 'http://api.flickr.com/services/feeds/photos_public.gne?tags=paris,church&lang=en-us&format=json',
							{ type: 'get',
								dataType: 'jsonp',
								jsonpCallback: 'jsonFlickrFeed',
								data: {'tags': 'goat,pasture',
								 		'lang': 'en-us',
										'format': 'json'},
							})
							.done( function( data, textStatus, jqXHR ){
								var items = [];

								$.each( data.items, function( key, photo ) {
									// cacheImageFetchURL( photo.media.m );	// Cache the image for later use

									$('#flickrTest').append( $('<img />').cacheImages({url: photo.media.m}) );	// Using the caching immediately
								});
							});
			});
		});

		/*
		 *	Grab all of the images and display them inside the container
		 */

		var cacheKeys = [];	// Store the keys we need to drop here
		var cacheImagesShowAll = function( container ){
			var cacheKeys = [];	// Store the keys we need to drop here
			// Lets get our loop on
			for (i = 0; i < window.localStorage.length; i++) {
				if( window.localStorage.key(i).substr( 0, window.cacheImagesConfig.storagePrefix.length + 1 ) !== window.cacheImagesConfig.storagePrefix + ':' ){ continue; }	// Does not match our prefix?

				cacheKeys.push( window.localStorage.key(i) ); // Droping the keys here re-indexes the localStorage so that the offset in our loop is wrong
			}

			if( cacheKeys.length ===  0 ){
				if( window.cacheImagesConfig.debug ){ console.log( 'No Images to Drop' ); }
				return true;
			}

			// Show the images we found
			for( i = 0; i < cacheKeys.length; i++ ){
				// if( $('#' + cacheKeys[i] ).length > 0 ){ continue; }
				if(  window.localStorage.getItem( cacheKeys[i] ) === 'pending' ){ continue; }
				if(  window.localStorage.getItem( cacheKeys[i] ) === 'error' ){ continue; }

				container.append( $('<img />').prop( 'src', window.localStorage.getItem( cacheKeys[i] ) ).width('25%') );
			}

			return true;
		};
	</script>
  </body>
</html>