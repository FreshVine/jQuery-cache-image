window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;$.fn.cacheImages.defaults.ready=false;if($.fn.cacheImages.defaults.debug){console.log("cacheImages will use indexedDB ")}if(typeof $.fn.cacheImages.defaults.indexedDbName==="undefined"){$.fn.cacheImages.defaults.indexedDbName="cacheImages"}$.fn.cacheImages.dbRequest=window.indexedDB.open($.fn.cacheImages.defaults.indexedDbName,1);var cacheImagesDb;$.fn.cacheImages.defaults.indexedDbStatus=false;$.fn.cacheImages.dbRequest.onerror=function(e){$.fn.cacheImages.defaults.indexedDbStatus=false;if($.fn.cacheImages.defaults.debug){console.log("Why didn't you allow my web app to use IndexedDB?!")}};$.fn.cacheImages.dbRequest.onsuccess=function(e){if($.fn.cacheImages.defaults.debug){console.log("IndexedDB open success. It is ready")}$.fn.cacheImages.defaults.ready=$.fn.cacheImages.defaults.indexedDbStatus=true;window.cacheImagesDb=e.target.result;window.cacheImagesDb.onerror=function(e){if($.fn.cacheImages.defaults.debug){console.log("IndexedDB error: "+e.target.errorCode)}}};$.fn.cacheImages.dbRequest.onupgradeneeded=function(e){if($.fn.cacheImages.defaults.debug){console.log("running onupgradeneeded")}var t=e.target.result;if(!t.objectStoreNames.contains("offlineImages")){console.log("making the offlineImages objectstore");var n=t.createObjectStore("offlineImages",{keyPath:"key"});var r=n.createIndex("by_key","key",{unique:true})}};$.fn.cacheImages.storageAvailable=function(e,t,n,r){if($.fn.cacheImages.defaults.debug){console.log("indexedDB availability check")}if($.fn.cacheImages.defaults.indexedDbStatus===true){r.call(e,t,n);if($.fn.cacheImages.defaults.debug){console.log("indexedDB already ready")}return}var i=0,s=setInterval(function(){i++;if($.fn.cacheImages.defaults.indexedDbStatus===true){if($.fn.cacheImages.defaults.debug){console.log("indexedDB ready to use","indexedDB took "+i*50+"ms to conenct")}r.call(e,t,n);clearInterval(s);return}if(i>=41){if($.fn.cacheImages.defaults.debug){console.log("indexedDB did not load")}clearInterval(s);return}if($.fn.cacheImages.defaults.debug){console.log("indexedDB not yet available")}},50);return};$.fn.cacheImages.set=function(e,t,n,r){var i=window.cacheImagesDb.transaction("offlineImages","readwrite").objectStore("offlineImages"),s={key:t,image:n},o=i.put(s);o.onsuccess=function(i){if(typeof r==="function"){r.call(e,t,n)}};o.onerror=function(e){self.cacheImagesConfig.fail.call(this);self.cacheImagesConfig.always.call(this)}};$.fn.cacheImages.get=function(e,t,n){var r=window.cacheImagesDb.transaction("offlineImages","readonly").objectStore("offlineImages").get(t);r.onsuccess=function(r){encodedString="";if(typeof r.target.result!=="undefined"&&typeof r.target.result.image==="string"){encodedString=r.target.result.image}if(typeof n==="function"){n.call(e,t,encodedString)}};r.onerror=function(e){self.cacheImagesConfig.fail.call(this);self.cacheImagesConfig.always.call(this)}};$.fn.cacheImages.Output=function(e,n,t){if(typeof t==="undefined"||typeof t==="null"){t=$.fn.cacheImages.defaults.storagePrefix}var r=t+":"+e,i=this;var s=window.cacheImagesDb.transaction("offlineImages","readonly").objectStore("offlineImages").get(r);s.onsuccess=function(e){var r="";if(typeof e.target.result!=="undefined"&&typeof e.target.result.image==="string"&&/^data:image/.test(e.target.result.image)===true){r=e.target.result.image}if(r==""){if(/^data:image/.test($.fn.cacheImages.defaults.defaultImage)===true){r=$.fn.cacheImages.defaults.defaultImage}else{$.fn.cacheImages.Output($.fn.cacheImages.defaults.defaultImage,n,t);return}}if(typeof n==="function"){n.call(i,r)}};return null};$.fn.cacheImages.drop=function(e,t){var n=[],r=false;if(typeof t==="undefined"){t=$.fn.cacheImages.defaults.storagePrefix}if(typeof e==="undefined"){e=null}var s=window.cacheImagesDb.transaction("offlineImages","readonly").objectStore("offlineImages").openCursor();s.onsuccess=function(s){var o=s.target.result;if(o){if(o.value.key.substr(0,t.length+1)===t+":"){if(e===null||o.value.key===t+":"+e){n.push(o.value.key)}}o.continue()}else{console.log("No more matching records");if(n.length===0){if(r){console.log("No Images to Drop")}return true}for(i=0;i<n.length;i++){if(r){console.log("Dropping localStorage Key:",n[i])}window.cacheImagesDb.transaction("offlineImages","readwrite").objectStore("offlineImages").delete(n[i])}if(r){console.log("Dropped "+n.length+" images from indexedDB")}return true}}}