window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,$.fn.cacheImages.defaults.ready=!1,$.fn.cacheImages.defaults.debug&&console.log("cacheImages will use indexedDB ");var cacheImagesDb;"undefined"==typeof $.fn.cacheImages.defaults.indexedDbName&&($.fn.cacheImages.defaults.indexedDbName="cacheImages"),$.fn.cacheImages.dbRequest=window.indexedDB.open($.fn.cacheImages.defaults.indexedDbName,1),$.fn.cacheImages.defaults.indexedDbStatus=!1,$.fn.cacheImages.dbRequest.onerror=function(){$.fn.cacheImages.defaults.indexedDbStatus=!1,$.fn.cacheImages.defaults.debug&&console.log("Why didn't you allow my web app to use IndexedDB?!")},$.fn.cacheImages.dbRequest.onsuccess=function(e){$.fn.cacheImages.defaults.debug&&console.log("IndexedDB open success. It is ready"),$.fn.cacheImages.defaults.ready=$.fn.cacheImages.defaults.indexedDbStatus=!0,window.cacheImagesDb=e.target.result,window.cacheImagesDb.onerror=function(e){$.fn.cacheImages.defaults.debug&&console.log("IndexedDB error: "+e.target.errorCode)}},$.fn.cacheImages.dbRequest.onupgradeneeded=function(e){$.fn.cacheImages.defaults.debug&&console.log("running onupgradeneeded");var a=e.target.result;if(!a.objectStoreNames.contains("offlineImages")){$.fn.cacheImages.defaults.debug&&console.log("making the offlineImages objectstore");{var n=a.createObjectStore("offlineImages",{keyPath:"key"});n.createIndex("by_key","key",{unique:!0})}}},$.fn.cacheImages.storageAvailable=function(e,a,n,t){if($.fn.cacheImages.defaults.debug&&console.log("indexedDB availability check"),$.fn.cacheImages.defaults.indexedDbStatus===!0)return t.call(e,a,n),void($.fn.cacheImages.defaults.debug&&console.log("indexedDB already ready"));var c=0,o=setInterval(function(){return c++,$.fn.cacheImages.defaults.indexedDbStatus===!0?($.fn.cacheImages.defaults.debug&&console.log("indexedDB ready to use","indexedDB took "+50*c+"ms to conenct"),t.call(e,a,n),void clearInterval(o)):c>=41?($.fn.cacheImages.defaults.debug&&console.log("indexedDB did not load"),void clearInterval(o)):void($.fn.cacheImages.defaults.debug&&console.log("indexedDB not yet available"))},50)},$.fn.cacheImages.set=function(e,a,n,t){var c=window.cacheImagesDb.transaction("offlineImages","readwrite").objectStore("offlineImages"),o={key:a,image:n},s=c.put(o);s.onsuccess=function(){"function"==typeof t&&t.call(e,a,n)},s.onerror=function(){self.cacheImagesConfig.fail.call(this),self.cacheImagesConfig.always.call(this)}},$.fn.cacheImages.get=function(e,a,n){var t=window.cacheImagesDb.transaction("offlineImages","readonly").objectStore("offlineImages").get(a);t.onsuccess=function(t){encodedString="","undefined"!=typeof t.target.result&&"string"==typeof t.target.result.image&&(encodedString=t.target.result.image),"function"==typeof n&&n.call(e,a,encodedString)},t.onerror=function(){self.cacheImagesConfig.fail.call(this),self.cacheImagesConfig.always.call(this)}},$.fn.cacheImages.Output=function(e,a,n){("undefined"==typeof n||"null"==typeof n)&&(n=$.fn.cacheImages.defaults.storagePrefix);var t=n+":"+e,c=this,o=window.cacheImagesDb.transaction("offlineImages","readonly").objectStore("offlineImages").get(t);return o.onsuccess=function(e){var t="";if("undefined"!=typeof e.target.result&&"string"==typeof e.target.result.image&&/^data:image/.test(e.target.result.image)===!0&&(t=e.target.result.image),""==t){if(/^data:image/.test($.fn.cacheImages.defaults.defaultImage)!==!0)return void $.fn.cacheImages.Output($.fn.cacheImages.defaults.defaultImage,a,n);t=$.fn.cacheImages.defaults.defaultImage}"function"==typeof a&&a.call(c,t)},null},$.fn.cacheImages.drop=function(e,a,n){var t=[];"undefined"==typeof n&&(n=$.fn.cacheImages.defaults.storagePrefix),"undefined"==typeof e&&(e=null);var c=window.cacheImagesDb.transaction("offlineImages","readonly").objectStore("offlineImages").openCursor();c.onsuccess=function(c){var o=c.target.result;if(!o){if($.fn.cacheImages.defaults.debug&&console.log("No more matching records"),0===t.length)$.fn.cacheImages.defaults.debug&&console.log("No Images to Drop");else{for(i=0;i<t.length;i++)$.fn.cacheImages.defaults.debug&&console.log("Dropping localStorage Key:",t[i]),window.cacheImagesDb.transaction("offlineImages","readwrite").objectStore("offlineImages")["delete"](t[i]);$.fn.cacheImages.defaults.debug&&console.log("Dropped "+t.length+" images from indexedDB")}return"function"==typeof a&&a.call(thisElem,key,encodedString),!0}o.value.key.substr(0,n.length+1)===n+":"&&(null===e||o.value.key===n+":"+e)&&t.push(o.value.key),o["continue"]()}};